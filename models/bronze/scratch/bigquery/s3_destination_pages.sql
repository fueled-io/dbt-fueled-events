{{ config(materialized='ephemeral') }}

{% if var('include_s3_destination_data', false) %}
SELECT
    JSON_VALUE(context, '$.os.name')                                                     AS context_os_name,
    COALESCE(anonymousId, JSON_VALUE(context, '$.anonymousId'))                          AS context_anonymous_id,
    JSON_VALUE(context, '$.campaign.gclid')                                              AS context_campaign_gclid,
    JSON_VALUE(context, '$.version')                                                     AS context_version,
    JSON_VALUE(context, '$.fb.fbc')                                                      AS context_fb_fbc,
    TIMESTAMP_SECONDS(original_timestamp)                                                AS timestamp,
    SAFE_CAST(NULL          AS STRING)                                                        AS context_destination_id,
    JSON_VALUE(context, '$.campaign.klaviyoId')                                          AS context_campaign_klaviyo_id,
    'server'                                                                           AS channel,
    JSON_VALUE(context, '$.page.referrer')                                              AS context_page_referrer,
    JSON_VALUE(context, '$.campaign.medium')                                             AS context_campaign_medium,
    TIMESTAMP_SECONDS(original_timestamp)                                                AS sent_at,
    JSON_VALUE(context, '$.fueledExternalId')                                           AS context_fueled_external_id,
    SAFE_CAST(JSON_VALUE(properties, '$.height')  AS INT64)                                   AS height,
    TIMESTAMP_SECONDS(hydration_timestamp)                                               AS loaded_at,
    JSON_VALUE(context, '$.page.path')                                                  AS context_page_path,
    JSON_VALUE(context, '$.page.url')                                                   AS context_page_url,
    JSON_VALUE(context, '$.klaviyoExchangeId')                                           AS context_klaviyo_exchange_id,
    JSON_VALUE(context, '$.page.path')                                                                               AS path,
    JSON_VALUE(context, '$.ga4.clientId')                                               AS context_ga4_client_id,
    JSON_VALUE(context, '$.ga4.clientId')                                               AS context_ga_4_client_id,

    event_id                                                                           AS id,
    SAFE_CAST(JSON_VALUE(context, '$.debug') AS BOOL)                                       AS context_debug,
    JSON_VALUE(context, '$.referrer')                                                  AS context_referrer,
    JSON_VALUE(context, '$.ga4.userId')                                                AS context_ga4_user_id,
    event_name                                                                         AS name,
    JSON_VALUE(properties, '$.search')                                                  AS search,
    JSON_VALUE(context, '$.page.title')                                                AS context_page_title,
    TIMESTAMP_SECONDS(hydration_timestamp)                                              AS received_at,
    COALESCE(
                JSON_VALUE(properties, '$.phone'),
                JSON_VALUE(customer,   '$.phone'),
                JSON_VALUE(context,    '$.traits.phone')
                )                                                                              AS context_traits_phone,
    JSON_VALUE(context, '$.ip')                                                       AS context_request_ip,
    SAFE_CAST(JSON_VALUE(context, '$.initialized') AS BOOL)                                 AS context_initialized,
    SAFE_CAST(JSON_VALUE(properties, '$.height')  AS INT64)                                  AS context_page_height,
    COALESCE(sessionId, JSON_VALUE(context, '$.sessionId'))                            AS context_session_id,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_destination_type,
    JSON_VALUE(context, '$.library.version')                                           AS context_library_version,
    JSON_VALUE(context, '$.campaign.content')                                          AS context_campaign_content,
    JSON_VALUE(properties, '$.url')                                                     AS url,
    JSON_VALUE(context, '$.campaign.name')                                             AS context_campaign_name,
    SAFE_CAST(JSON_VALUE(properties, '$.width')   AS INT64)                                  AS width,
    JSON_VALUE(context, '$.fb.externalId')                                              AS context_fb_external_id,
    JSON_VALUE(context, '$.ga4.sessionId')                                              AS context_ga4_session_id,
    JSON_VALUE(context, '$.ga4.sessionId')                                              AS context_ga_4_session_id,

    sourceEndpointId                                                                  AS context_source_id,
    SAFE_CAST(JSON_VALUE(properties, '$.width')   AS INT64)                                  AS context_page_width,
    JSON_VALUE(context, '$.campaign.id')                                               AS context_campaign_id,
    JSON_VALUE(context, '$.campaign.source')                                           AS context_campaign_source,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.term')  AS BOOL)                               AS context_campaign_term,
    JSON_VALUE(context, '$.library.name')                                              AS context_library_name,
    JSON_VALUE(properties, '$.referrer')                                                AS referrer,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_source_type,
    JSON_VALUE(context, '$.timezone')                                                  AS context_timezone,
    userId                                                                             AS user_id,
    JSON_VALUE(context, '$.fb.fbp')                                                     AS context_fb_fbp,
    JSON_VALUE(context, '$.fb.eventId')                                                AS context_fb_event_id,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_ip,
    JSON_VALUE(context, '$.userAgent')                                                 AS context_user_agent,
    schema_version                                                                    AS context_endpoint_version,
    TIMESTAMP_SECONDS(original_timestamp)                                               AS uuid_ts,
    SAFE_CAST(JSON_VALUE(context, '$.offline')  AS BOOL)                                    AS context_offline,
    JSON_VALUE(properties, '$.search')                                                 AS context_page_search,
    JSON_VALUE(context, '$.traits.address.countryCode')                                AS context_traits_address_country_code,
    JSON_VALUE(properties, '$.title')                                                  AS title,
    JSON_VALUE(context, '$.app')                                                       AS context_app,
    JSON_VALUE(context, '$.locale')                                                    AS context_locale,
    COALESCE(
                JSON_VALUE(properties, '$.email'),
                JSON_VALUE(customer,   '$.email'),
                JSON_VALUE(context,    '$.traits.email')
                )                                                                              AS context_traits_email,
    TIMESTAMP_SECONDS(original_timestamp)                                               AS original_timestamp,
    JSON_VALUE(context, '$.traits.name')                                               AS context_traits_name,
    SAFE_CAST(JSON_VALUE(context, '$.traits.lifetimeValue') AS FLOAT64)                     AS context_traits_lifetime_value,
    JSON_VALUE(context, '$.traits.address.stateCode')                                  AS context_traits_address_state_code,
    JSON_VALUE(context, '$.traits.visitorType')                                        AS context_traits_visitor_type,
    COALESCE(
                JSON_VALUE(context, '$.traits.externalCustomerId'),
                JSON_VALUE(customer,   '$.externalCustomerId')
                )                                                                              AS context_traits_external_customer_id,
    JSON_VALUE(context, '$.page.hash')                                                 AS context_page_hash,
    JSON_VALUE(context, '$.traits.shopifyCustomerId')                                  AS context_traits_shopify_customer_id,
    JSON_VALUE(context, '$.traits.address.postalCode')                                 AS context_traits_address_postal_code,
    JSON_VALUE(context, '$.traits.address.city')                                       AS context_traits_address_city,
    SAFE_CAST(NULL          AS STRING)                                                      AS _hash,
    COALESCE(
                JSON_VALUE(properties, '$.first_name'),
                JSON_VALUE(customer,   '$.firstName'),
                JSON_VALUE(context,    '$.traits.firstName')
                )                                                                              AS context_traits_first_name,
    JSON_VALUE(context, '$.traits.address.street')                                     AS context_traits_address_street,
    SAFE_CAST(JSON_VALUE(context, '$.traits.orderCount')  AS INT64)                         AS context_traits_order_count,
    JSON_VALUE(context, '$.traits.address.state')                                      AS context_traits_address_state,
    JSON_VALUE(context, '$.traits.address.country')                                    AS context_traits_address_country,
    COALESCE(
                JSON_VALUE(properties, '$.last_name'),
                JSON_VALUE(customer,   '$.lastName'),
                JSON_VALUE(context,    '$.traits.lastName')
                )                                                                              AS context_traits_last_name,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_source_platform,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_redirect,
    JSON_VALUE(context, '$.campaign.agid')                           AS context_campaign_agid,
    JSON_VALUE(context, '$.campaign.audience')                                         AS context_campaign_audience,
    JSON_VALUE(context, '$.campaign.marketingAudience')                                AS context_campaign_marketing_audience,
    JSON_VALUE(context, '$.campaign.marketingTactic')                                  AS context_campaign_marketing_tactic,
    JSON_VALUE(context, '$.campaign.customerType')                                     AS context_campaign_customertype,
    SAFE_CAST(JSON_VALUE(context, '$.trackingConsent.analytics') AS BOOL)                   AS context_tracking_consent_analytics,
    SAFE_CAST(JSON_VALUE(context, '$.trackingConsent.preferences') AS BOOL)                 AS context_tracking_consent_preferences,
    SAFE_CAST(JSON_VALUE(context, '$.trackingConsent.saleOfData') AS BOOL)                  AS context_tracking_consent_sale_of_data,
    SAFE_CAST(JSON_VALUE(context, '$.trackingConsent.marketing') AS BOOL)                   AS context_tracking_consent_marketing,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_targeting,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_fbaudience,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_segm,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_traits_fired_from,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_traits_custom_client_id,
    SAFE_CAST(JSON_VALUE(context, '$.traits.ecommerceEvent')   AS BOOL)                      AS context_traits_ecommerce_event,
    SAFE_CAST(NULL          AS STRING)                                                      AS context_campaign_audiance,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.medi')      AS BOOL)                            AS context_campaign_medi,
    JSON_VALUE(context, '$.campaign.customer')                                            AS context_campaign_customer,
    JSON_VALUE(context, '$.ipv4')                                                         AS context_ipv4,
    JSON_VALUE(context, '$.ipv6')                                                         AS context_ipv6,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.campai')   AS BOOL)                              AS context_campaign_campai,
    SAFE_CAST(NULL          AS BOOL)                                                        AS context_category_preferences_advertising,
    SAFE_CAST(NULL          AS BOOL)                                                        AS context_category_preferences_data_sharing,
    SAFE_CAST(NULL          AS BOOL)                                                        AS context_category_preferences_functional,
    SAFE_CAST(NULL          AS BOOL)                                                        AS context_category_preferences_analytics,
    JSON_VALUE(context, '$.opensendPersistentId')                                      AS context_opensend_persistent_id,
    JSON_VALUE(context, '$.opensendIdToken')                                           AS context_opensend_id_token,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.campaign_session_abandonment_non_purchaser_w_neiax') AS BOOL) AS context_campaign_campaign_session_abandonment_non_purchaser_w_neiax,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.mediumEmail')   AS BOOL)                         AS context_campaign_mediumemail,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.klaviyoId01_j56_je0_asvp5_g4_p9_bs31_vaj1_m') AS BOOL) AS context_campaign_klaviyo_id01_j56_je0_asvp5_g4_p9_bs31_vaj1_m,
    SAFE_CAST(JSON_VALUE(context, '$.campaign.source_klaviyo')  AS BOOL)                      AS context_campaign_source_klaviyo

FROM {{ source('s3_destination_fueled_events','fueled_events') }}
WHERE event_name = 'Page View'

{% else %}

SELECT
    SAFE_CAST(NULL AS STRING) AS context_os_name,
    SAFE_CAST(NULL AS STRING) AS context_anonymous_id,
    SAFE_CAST(NULL AS STRING) AS context_campaign_gclid,
    SAFE_CAST(NULL AS STRING) AS context_version,
    SAFE_CAST(NULL AS STRING) AS context_fb_fbc,
    SAFE_CAST(NULL AS TIMESTAMP) AS timestamp,
    SAFE_CAST(NULL AS STRING) AS context_destination_id,
    SAFE_CAST(NULL AS STRING) AS context_campaign_klaviyo_id,
    SAFE_CAST(NULL AS STRING) AS channel,
    SAFE_CAST(NULL AS STRING) AS context_page_referrer,
    SAFE_CAST(NULL AS STRING) AS context_campaign_medium,
    SAFE_CAST(NULL AS TIMESTAMP) AS sent_at,
    SAFE_CAST(NULL AS STRING) AS context_fueled_external_id,
    SAFE_CAST(NULL AS INT64) AS height,
    SAFE_CAST(NULL AS TIMESTAMP) AS loaded_at,
    SAFE_CAST(NULL AS STRING) AS context_page_path,
    SAFE_CAST(NULL AS STRING) AS context_page_url,
    SAFE_CAST(NULL AS STRING) AS context_klaviyo_exchange_id,
    SAFE_CAST(NULL AS STRING) AS path,
    SAFE_CAST(NULL AS STRING) AS context_ga4_client_id,
    SAFE_CAST(NULL AS STRING) AS context_ga_4_client_id,
    SAFE_CAST(NULL AS STRING) AS id,
    SAFE_CAST(NULL AS BOOL) AS context_debug,
    SAFE_CAST(NULL AS STRING) AS context_referrer,
    SAFE_CAST(NULL AS STRING) AS context_ga4_user_id,
    SAFE_CAST(NULL AS STRING) AS name,
    SAFE_CAST(NULL AS STRING) AS search,
    SAFE_CAST(NULL AS STRING) AS context_page_title,
    SAFE_CAST(NULL AS TIMESTAMP) AS received_at,
    SAFE_CAST(NULL AS STRING) AS context_traits_phone,
    SAFE_CAST(NULL AS STRING) AS context_request_ip,
    SAFE_CAST(NULL AS BOOL) AS context_initialized,
    SAFE_CAST(NULL AS INT64) AS context_page_height,
    SAFE_CAST(NULL AS STRING) AS context_session_id,
    SAFE_CAST(NULL AS STRING) AS context_destination_type,
    SAFE_CAST(NULL AS STRING) AS context_library_version,
    SAFE_CAST(NULL AS STRING) AS context_campaign_content,
    SAFE_CAST(NULL AS STRING) AS url,
    SAFE_CAST(NULL AS STRING) AS context_campaign_name,
    SAFE_CAST(NULL AS INT64) AS width,
    SAFE_CAST(NULL AS STRING) AS context_fb_external_id,
    SAFE_CAST(NULL AS STRING) AS context_ga4_session_id,
    SAFE_CAST(NULL AS STRING) AS context_ga_4_session_id,
    SAFE_CAST(NULL AS STRING) AS context_source_id,
    SAFE_CAST(NULL AS INT64) AS context_page_width,
    SAFE_CAST(NULL AS STRING) AS context_campaign_id,
    SAFE_CAST(NULL AS STRING) AS context_campaign_source,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_term,
    SAFE_CAST(NULL AS STRING) AS context_library_name,
    SAFE_CAST(NULL AS STRING) AS referrer,
    SAFE_CAST(NULL AS STRING) AS context_source_type,
    SAFE_CAST(NULL AS STRING) AS context_timezone,
    SAFE_CAST(NULL AS STRING) AS user_id,
    SAFE_CAST(NULL AS STRING) AS context_fb_fbp,
    SAFE_CAST(NULL AS STRING) AS context_fb_event_id,
    SAFE_CAST(NULL AS STRING) AS context_ip,
    SAFE_CAST(NULL AS STRING) AS context_user_agent,
    SAFE_CAST(NULL AS STRING) AS context_endpoint_version,
    SAFE_CAST(NULL AS TIMESTAMP) AS uuid_ts,
    SAFE_CAST(NULL AS BOOL) AS context_offline,
    SAFE_CAST(NULL AS STRING) AS context_page_search,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_country_code,
    SAFE_CAST(NULL AS STRING) AS title,
    SAFE_CAST(NULL AS STRING) AS context_app,
    SAFE_CAST(NULL AS STRING) AS context_locale,
    SAFE_CAST(NULL AS STRING) AS context_traits_email,
    SAFE_CAST(NULL AS TIMESTAMP) AS original_timestamp,
    SAFE_CAST(NULL AS STRING) AS context_traits_name,
    SAFE_CAST(NULL AS FLOAT64) AS context_traits_lifetime_value,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_state_code,
    SAFE_CAST(NULL AS STRING) AS context_traits_visitor_type,
    SAFE_CAST(NULL AS STRING) AS context_traits_external_customer_id,
    SAFE_CAST(NULL AS STRING) AS context_page_hash,
    SAFE_CAST(NULL AS STRING) AS context_traits_shopify_customer_id,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_postal_code,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_city,
    SAFE_CAST(NULL AS STRING) AS _hash,
    SAFE_CAST(NULL AS STRING) AS context_traits_first_name,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_street,
    SAFE_CAST(NULL AS INT64) AS context_traits_order_count,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_state,
    SAFE_CAST(NULL AS STRING) AS context_traits_address_country,
    SAFE_CAST(NULL AS STRING) AS context_traits_last_name,
    SAFE_CAST(NULL AS STRING) AS context_campaign_source_platform,
    SAFE_CAST(NULL AS STRING) AS context_campaign_redirect,
    SAFE_CAST(NULL AS STRING) AS context_campaign_agid,
    SAFE_CAST(NULL AS STRING) AS context_campaign_audience,
    SAFE_CAST(NULL AS STRING) AS context_campaign_marketing_audience,
    SAFE_CAST(NULL AS STRING) AS context_campaign_marketing_tactic,
    SAFE_CAST(NULL AS STRING) AS context_campaign_customertype,
    SAFE_CAST(NULL AS BOOL) AS context_tracking_consent_analytics,
    SAFE_CAST(NULL AS BOOL) AS context_tracking_consent_preferences,
    SAFE_CAST(NULL AS BOOL) AS context_tracking_consent_sale_of_data,
    SAFE_CAST(NULL AS BOOL) AS context_tracking_consent_marketing,
    SAFE_CAST(NULL AS STRING) AS context_campaign_targeting,
    SAFE_CAST(NULL AS STRING) AS context_campaign_fbaudience,
    SAFE_CAST(NULL AS STRING) AS context_campaign_segm,
    SAFE_CAST(NULL AS STRING) AS context_traits_fired_from,
    SAFE_CAST(NULL AS STRING) AS context_traits_custom_client_id,
    SAFE_CAST(NULL AS BOOL) AS context_traits_ecommerce_event,
    SAFE_CAST(NULL AS STRING) AS context_campaign_audiance,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_medi,
    SAFE_CAST(NULL AS STRING) AS context_campaign_customer,
    SAFE_CAST(NULL AS STRING) AS context_ipv4,
    SAFE_CAST(NULL AS STRING) AS context_ipv6,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_campai,
    SAFE_CAST(NULL AS BOOL) AS context_category_preferences_advertising,
    SAFE_CAST(NULL AS BOOL) AS context_category_preferences_data_sharing,
    SAFE_CAST(NULL AS BOOL) AS context_category_preferences_functional,
    SAFE_CAST(NULL AS BOOL) AS context_category_preferences_analytics,
    SAFE_CAST(NULL AS STRING) AS context_opensend_persistent_id,
    SAFE_CAST(NULL AS STRING) AS context_opensend_id_token,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_campaign_session_abandonment_non_purchaser_w_neiax,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_mediumemail,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_klaviyo_id01_j56_je0_asvp5_g4_p9_bs31_vaj1_m,
    SAFE_CAST(NULL AS BOOL) AS context_campaign_source_klaviyo
FROM (SELECT 1) AS dummy
WHERE FALSE

{% endif %}
